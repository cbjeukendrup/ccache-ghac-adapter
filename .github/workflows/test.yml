name: Test

on:
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v6

      - name: Install ccache and ninja
        run: |
          echo "Installing ccache..."
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update
            sudo apt-get install -y ccache ninja-build
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install ccache ninja
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            choco install ccache ninja
          fi
      
      - name: Configure ccache
        run: |
          export CCACHE_DIR=$GITHUB_WORKSPACE/.ccache
          mkdir -p $CCACHE_DIR

          echo "CCACHE_DIR=$CCACHE_DIR" | tee -a $GITHUB_ENV
          echo "base_dir = $GITHUB_WORKSPACE" >$CCACHE_DIR/ccache.conf
          echo "compression = true" >>$CCACHE_DIR/ccache.conf
          echo "compression_level = 5" >>$CCACHE_DIR/ccache.conf
          echo "sloppiness=pch_defines,time_macros" >>$CCACHE_DIR/ccache.conf
          cat $CCACHE_DIR/ccache.conf

          ccache -sv
          ccache -z

      - name: Build
        run: |
          cd test/data
          mkdir build
          cd build
          cmake .. -GNinja -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -DVALUE=$GITHUB_RUN_ID
          cmake --build .

      - name: Show ccache stats
        run: |
          ccache -sv

      - name: Build again to test cache hit
        run: |
          cd test/data
          rm -rf build
          mkdir build
          cd build
          cmake .. -GNinja -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -DVALUE=$GITHUB_RUN_ID
          cmake --build .

      - name: Show ccache stats after second build
        run: |
          ccache -sv
